<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kero Assistance - Home</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

    <style>
        body { font-family: 'Arial', sans-serif; background-color: #f0f8ff; margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; color: #424242; }
        .container { background-color: #fff; border-radius: 12px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); padding: 30px; width: 85%; max-width: 900px; text-align: center; margin-top: 20px; margin-bottom: 20px; position: relative; }
        .page { display: none; }
        h1 { color: #1e88e5; margin-bottom: 20px; }
        #kero-assistance { font-size: 2em; }
        .subtitle { font-size: 1.5em; font-style: italic; }
        .section { margin-bottom: 25px; padding: 20px; border: 1px solid #bbdefb; border-radius: 8px; background-color: #e3f2fd; }
        .instructions { font-size: 0.9em; color: #555; background-color: #fffde7; padding: 10px; border-radius: 5px; border: 1px dashed #fbc02d; margin-bottom: 15px; }
        .location-container { display: flex; justify-content: space-around; align-items: center; margin-bottom: 15px; }
        .location-container select { width: 45%; padding: 10px; border: 1px solid #bbdefb; border-radius: 5px; box-sizing: border-box; font-size: 16px; }
        input[type="file"] { display: none; }
        button { background-color: #009688; color: white; border: none; padding: 14px 28px; border-radius: 8px; cursor: pointer; font-size: 16px; margin: 5px; transition: background-color 0.3s ease; }
        button:hover:not(:disabled) { background-color: #00796b; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        .main-action-button { font-size: 18px; padding: 16px 32px; background-color: #4caf50; margin-top: 10px; }
        .main-action-button:hover:not(:disabled) { background-color: #388e3c; }
        .home-button { display: block; width: 80%; margin: 15px auto; padding: 25px; font-size: 1.2em; background-color: #2196f3; }
        .home-button:hover { background-color: #1976d2; }
        .home-nav-button { background-color: #607d8b; position: absolute; top: 20px; left: 20px; }
        .home-nav-button:hover { background-color: #455a64; }
        .message-display { margin-top: 20px; font-weight: bold; min-height: 1.2em; padding: 8px; border-radius: 4px; }
        .message-display.success { color: #2e7d32; background-color: #e8f5e9; }
        .message-display.info { color: #1976d2; background-color: #e3f2fd; }
        .message-display.error { color: #c62828; background-color: #ffebee; }
        .select2-container { width: 100% !important; }
        .select2-selection { border: 1px solid #bbdefb !important; border-radius: 5px !important; padding: 6px 12px !important; height: auto !important; }
        .version { position: fixed; top: 10px; right: 10px; font-size: 0.8em; color: #777; }
    </style>
</head>

<body>
    <div class="version">v 5.0 - Unrestricted Buttons</div>

    <!-- Home Page -->
    <div id="homePage" class="container page">
        <h1><span id="kero-assistance">Kero Assistance</span></h1>
        <p>Please select a tool to continue.</p>
        <div class="section">
            <button id="goToTransferBtn" class="home-button">Stock Transfer Management</button>
            <button id="goToValidatorBtn" class="home-button">Barcode Validator & Retriever</button>
        </div>
        <div class="message-display">Fetching product database...</div>
    </div>

    <!-- Stock Transfer Page -->
    <div id="stockTransferPage" class="container page">
        <button class="go-home-btn home-nav-button">Back to Home</button>
        <h1><span class="subtitle">Stock Transfer Management</span></h1>
        <div class="section">
            <div class="instructions">
                <strong>Instructions:</strong> Upload an Excel file (`.xlsx`). Data **must be on the first sheet** and the sheet must contain columns with the exact headers: <strong>code</strong> and <strong>quantity</strong>.
            </div>
            <div class="location-container">
                <select id="locationFrom" class="location-select"></select>
                <select id="locationTo" class="location-select"></select>
            </div>
            <input type="file" id="quantityFile" accept=".xlsx">
            <button id="uploadQuantityButton">Upload Quantity File</button>
            <button id="clearQuantity">Clear Quantity</button>
        </div>
        <button id="processTransferButton" class="main-action-button" disabled>Process Transfer and Download</button>
        <div class="message-display"></div>
    </div>

    <!-- Barcode Validator Page -->
    <div id="barcodeValidatorPage" class="container page">
        <button class="go-home-btn home-nav-button">Back to Home</button>
        <h1><span class="subtitle">Barcode Validator & Data Retriever</span></h1>
        <div class="section">
            <div class="instructions">
                <strong>Instructions:</strong> Upload an Excel file (`.xlsx`). Data **must be on the first sheet** and the sheet must contain a column with the exact header: <strong>barcode</strong>.
            </div>
            <input type="file" id="barcodeFile" accept=".xlsx">
            <button id="uploadBarcodeButton">Upload Barcode File</button>
            <button id="clearBarcodes">Clear Barcodes</button>
        </div>
        <button id="validateDownloadButton" class="main-action-button" disabled>Validate Barcodes and Download</button>
        <div class="message-display"></div>
    </div>

    <script>
        // --- GLOBAL VARIABLES ---
        let databaseData = null;
        let quantityData = null;
        let barcodeData = null;
        let activePageId = 'homePage';
        const googleSheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQNrRFFRPe_jrOrDZM58gRqxfsA0deD60_q2jkA7XJRRfJQ7IiBdIqNDN7JdMawjw/pub?output=csv';

        const locations = [
            { id: "جاردنز 101", text: "جاردنز 101" }, { id: "تلال السخنة 102", text: "تلال السخنة 102" },
            { id: "ستيلا 103", text: "ستيلا 103" }, { id: "الدبلو 104", text: "الدبلو 104" },
            { id: "تلال الساحل 105", text: "تلال الساحل 105" }, { id: "سوان لك 106", text: "سوان لك 106" },
            { id: "كاسكادا 107", text: "كاسكادا 107" }, { id: "لافيستا باي 108", text: "لافيستا باي 108" },
            { id: "راس الحكمة 109", text: "راس الحكمة 109" }, { id: "لازوردي 110", text: "لازوردي 110" },
            { id: "النادي 111", text: "النادي 111" }, { id: "زايد 112", text: "زايد 112" },
            { id: "القطامية 115", text: "القطامية 115" }, { id: "مخزن بلبيس 201", text: "مخزن بلبيس 201" },
            { id: "مخزن الساحل 202", text: "مخزن الساحل 202" },
        ];

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', function() {
            console.log("App Initializing...");
            showPage('homePage');
            fetchProductDatabase();
            
            const locationOptions = [{ id: '', text: 'Select Location' }, ...locations];
            $('#locationFrom, #locationTo').select2({ data: locationOptions });
            
            document.getElementById('goToTransferBtn').addEventListener('click', () => showPage('stockTransferPage'));
            document.getElementById('goToValidatorBtn').addEventListener('click', () => showPage('barcodeValidatorPage'));
            document.querySelectorAll('.go-home-btn').forEach(button => button.addEventListener('click', () => showPage('homePage')));
            
            document.getElementById('uploadQuantityButton').addEventListener('click', () => document.getElementById('quantityFile').click());
            document.getElementById('quantityFile').addEventListener('change', handleQuantityUpload);
            document.getElementById('clearQuantity').addEventListener('click', clearQuantity);
            document.getElementById('processTransferButton').addEventListener('click', processTransferData);

            document.getElementById('uploadBarcodeButton').addEventListener('click', () => document.getElementById('barcodeFile').click());
            document.getElementById('barcodeFile').addEventListener('change', handleBarcodeUpload);
            document.getElementById('clearBarcodes').addEventListener('click', clearBarcodes);
            document.getElementById('validateDownloadButton').addEventListener('click', processAndValidateBarcodes);
            console.log("Event listeners attached.");
        });

        // --- PAGE NAVIGATION ---
        function showPage(pageId) {
            console.log(`Navigating to page: ${pageId}`);
            activePageId = pageId;
            document.querySelectorAll('.page').forEach(page => page.style.display = 'none');
            const newPage = document.getElementById(pageId);
            if (newPage) {
                newPage.style.display = 'block';
                const msgDiv = newPage.querySelector('.message-display');
                if (msgDiv) {
                     msgDiv.innerText = '';
                     msgDiv.className = 'message-display';
                }
            }
        }
        
        // --- CORE LOGIC ---
        async function fetchProductDatabase() {
            console.log("Attempting to fetch product database...");
            showMessage('Fetching product database from Google Sheet...', 'info');
            try {
                const response = await fetch(googleSheetURL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const csvText = await response.text();
                parseCSVDatabase(csvText);
                console.log("Product database fetched and parsed successfully.");
                showMessage('Product database loaded successfully! Ready to use.', 'success');
                // *** CHANGE: Enable buttons now that the core data is loaded ***
                updateButtonStates();
            } catch (error) {
                console.error("CRITICAL: Failed to fetch product database.", error);
                showMessage(`Error fetching product database: ${error.message}. App cannot function.`, 'error');
            }
        }

        function parseCSVDatabase(csvText) {
            const rows = csvText.trim().split('\n');
            databaseData = rows.map(row => row.split(',').map(cell => cell.trim()));
            if (!databaseData || databaseData.length === 0) throw new Error("Parsed database CSV is empty.");
            const headers = databaseData[0].map(h => h.toLowerCase());
            const requiredDbHeaders = ['code', 'barcode', 'name'];
            if (requiredDbHeaders.some(h => !headers.includes(h))) {
                 throw new Error(`Google Sheet is missing a required header. It must contain: code, barcode, name.`);
            }
        }

        function handleQuantityUpload(event) {
            handleFileUpload(event, 'quantityData', 'Quantity', ['code', 'quantity']);
        }

        function handleBarcodeUpload(event) {
            handleFileUpload(event, 'barcodeData', 'Barcode', ['barcode']);
        }

        function handleFileUpload(event, dataVariableKey, sheetNameFriendly, requiredHeaders) {
            console.log(`--- Starting File Upload for: ${sheetNameFriendly} ---`);
            const file = event.target.files[0];
            if (!file) { return; }
            console.log(`File selected: ${file.name}`);

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    if (!workbook.SheetNames || workbook.SheetNames.length === 0) { throw new Error("Excel file contains no sheets."); }
                    
                    const firstSheetName = workbook.SheetNames[0];
                    console.log(`Reading data from the first sheet: "${firstSheetName}"`);
                    const sheet = workbook.Sheets[firstSheetName];
                    
                    const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
                    if (jsonData.length <= 1) { throw new Error(`The first sheet ("${firstSheetName}") is empty or has no data rows.`); }
                    
                    const headers = jsonData[0].map(header => String(header).toLowerCase().trim());
                    const missingHeaders = requiredHeaders.filter(header => !headers.includes(header));

                    if (missingHeaders.length > 0) { throw new Error(`The first sheet is missing required column(s): [${missingHeaders.join(', ')}].`); }
                    
                    window[dataVariableKey] = jsonData;
                    showMessage(`${sheetNameFriendly} file uploaded successfully! Ready to process.`, 'success');
                    console.log(`SUCCESS: ${dataVariableKey} now contains ${jsonData.length - 1} data rows.`);

                } catch (error) {
                    console.error("File upload failed:", error.message);
                    showMessage(`Upload Error: ${error.message}`, 'error');
                    window[dataVariableKey] = null;
                } finally {
                    event.target.value = '';
                    console.log("--- Finished File Upload Attempt ---");
                }
            };
            reader.onerror = () => {
                console.error("FileReader failed to read the file.");
                showMessage(`Error reading file. It may be corrupt or in use.`);
            }
            reader.readAsArrayBuffer(file);
        }

        function clearQuantity() {
            quantityData = null;
            console.log("Quantity data cleared.");
            showMessage('Quantity file has been cleared.', 'info');
        }

        function clearBarcodes() {
            barcodeData = null;
            console.log("Barcode data cleared.");
            showMessage('Barcode file has been cleared.', 'info');
        }

        // *** CHANGE: This function now just enables the buttons once the database loads. ***
        function updateButtonStates() {
            if (databaseData) {
                document.getElementById('processTransferButton').disabled = false;
                document.getElementById('validateDownloadButton').disabled = false;
                console.log("Main process buttons have been enabled.");
            }
        }
        
        // *** CHANGE: Moved validation checks inside the function. ***
        function processTransferData() {
            console.log("Starting 'Process Transfer Data'...");

            // --- VALIDATION CHECKS AT THE START ---
            if (!databaseData) return showMessage('Error: The main product database has not loaded. Please refresh.', 'error');
            
            const locationFromValue = document.getElementById('locationFrom').value;
            const locationToValue = document.getElementById('locationTo').value;
            if (!locationFromValue || !locationToValue) {
                return showMessage('Error: Please select both "Location From" and "Location To".', 'error');
            }
            
            if (!quantityData) {
                return showMessage('Error: Please upload a Quantity file before processing.', 'error');
            }
            // --- END OF VALIDATION ---
            
            try {
                // (Processing logic is unchanged)
                const results = [], unmatched = [];
                const dbHeaders = databaseData[0].map(h => String(h).toLowerCase().trim());
                const codeColumnDb = dbHeaders.indexOf('code'), barcodeColumnDb = dbHeaders.indexOf('barcode'), nameColumnDb = dbHeaders.indexOf('name');
                const quantityHeaders = quantityData[0].map(h => String(h).toLowerCase().trim());
                const codeColumnQuantity = quantityHeaders.indexOf('code'), quantityColumnQuantity = quantityHeaders.indexOf('quantity');
                for (let i = 1; i < quantityData.length; i++) {
                    const codeToFind = String(quantityData[i][codeColumnQuantity]).trim();
                    const quantity = quantityData[i][quantityColumnQuantity];
                    if (!codeToFind || quantity === undefined || quantity === null || quantity === '') continue;
                    let found = false;
                    for (let j = 1; j < databaseData.length; j++) {
                        const dbRow = databaseData[j];
                        if (dbRow[codeColumnDb] !== undefined && String(dbRow[codeColumnDb]).trim() === codeToFind) {
                            results.push({ Code: codeToFind, Barcode: dbRow[barcodeColumnDb] || '', Name: dbRow[nameColumnDb] || '', Quantity: quantity });
                            found = true;
                            break;
                        }
                    }
                    if (!found) unmatched.push({ Code: codeToFind, Quantity: quantity });
                }
                console.log(`Processing complete. Found: ${results.length}, Unmatched: ${unmatched.length}`);
                const wb = XLSX.utils.book_new();
                const resultsSheet = XLSX.utils.aoa_to_sheet([["Code", "Barcode", "Name", "Quantity"], ...results.map(item => [item.Code, item.Barcode, item.Name, item.Quantity])]);
                resultsSheet['!cols'] = [{ wch: 15 }, { wch: 20 }, { wch: 50 }, { wch: 10 }];
                XLSX.utils.book_append_sheet(wb, resultsSheet, "Results");
                if (unmatched.length > 0) {
                    const unmatchedSheet = XLSX.utils.aoa_to_sheet([["Code", "Quantity"], ...unmatched.map(item => [item.Code, item.Quantity])]);
                    unmatchedSheet['!cols'] = [{ wch: 15 }, { wch: 10 }];
                    XLSX.utils.book_append_sheet(wb, unmatchedSheet, "Unmatched");
                }
                const formattedDate = new Date().toISOString().slice(0, 10);
                XLSX.writeFile(wb, `من ${locationFromValue} الى ${locationToValue} ${formattedDate}.xlsx`);
                showMessage('Success! Transfer data processed and results downloaded.', 'success');
            } catch (error) { console.error("Error during transfer processing:", error); showMessage(`Error processing transfer data: ${error.message}`, 'error'); }
        }
        
        function validateEAN(barcode) { /* Logic is unchanged */
            const code = String(barcode).trim(); if (!/^\d+$/.test(code)) return 'Invalid Characters'; if (code.length !== 13) return 'Invalid Length'; let sum = 0; for (let i = 0; i < 12; i++) { sum += (i % 2 === 0) ? parseInt(code[i]) : parseInt(code[i]) * 3; } const calculatedCheckDigit = (10 - (sum % 10)) % 10; return (calculatedCheckDigit === parseInt(code[12])) ? 'Valid' : 'Invalid Checksum';
        }

        // *** CHANGE: Moved validation checks inside the function. ***
        function processAndValidateBarcodes() {
            console.log("Starting 'Process and Validate Barcodes'...");
            
            // --- VALIDATION CHECKS AT THE START ---
            if (!databaseData) return showMessage('Error: The main product database has not loaded. Please refresh.', 'error');
            
            if (!barcodeData) {
                return showMessage('Error: Please upload a Barcode file before processing.', 'error');
            }
            // --- END OF VALIDATION ---

            try {
                // (Processing logic is unchanged)
                const results = [];
                const dbHeaders = databaseData[0].map(h => String(h).toLowerCase().trim());
                const codeColumnDb = dbHeaders.indexOf('code'), barcodeColumnDb = dbHeaders.indexOf('barcode'), nameColumnDb = dbHeaders.indexOf('name');
                const barcodeHeaders = barcodeData[0].map(h => String(h).toLowerCase().trim());
                const barcodeColumnFile = barcodeHeaders.indexOf('barcode');
                for (let i = 1; i < barcodeData.length; i++) {
                    const barcodeToFind = (barcodeData[i][barcodeColumnFile] !== undefined) ? String(barcodeData[i][barcodeColumnFile]).trim() : '';
                    if (!barcodeToFind) continue;
                    const validationStatus = validateEAN(barcodeToFind);
                    let foundCode = 'Not Found', foundName = 'Not Found';
                    for (let j = 1; j < databaseData.length; j++) {
                        const dbRow = databaseData[j];
                        if (dbRow[barcodeColumnDb] !== undefined && String(dbRow[barcodeColumnDb]).trim() === barcodeToFind) {
                            foundCode = dbRow[codeColumnDb] || '';
                            foundName = dbRow[nameColumnDb] || '';
                            break;
                        }
                    }
                    results.push({ Barcode: barcodeToFind, Status: validationStatus, Code: foundCode, Name: foundName });
                }
                console.log(`Processing complete. Validated ${results.length} barcodes.`);
                const wb = XLSX.utils.book_new();
                const resultsSheet = XLSX.utils.aoa_to_sheet([["Barcode", "Validation Status", "Code", "Name"], ...results.map(item => [item.Barcode, item.Status, item.Code, item.Name])]);
                resultsSheet['!cols'] = [{ wch: 20 }, { wch: 20 }, { wch: 15 }, { wch: 50 }];
                XLSX.utils.book_append_sheet(wb, resultsSheet, "Validation Results");
                const formattedDate = new Date().toISOString().slice(0, 10);
                XLSX.writeFile(wb, `Barcode_Validation_Results_${formattedDate}.xlsx`);
                showMessage('Success! Barcodes validated and results downloaded.', 'success');
            } catch (error) { console.error("Error during barcode validation:", error); showMessage(`Error processing barcodes: ${error.message}`, 'error'); }
        }

        function showMessage(message, type = 'info') {
            const currentPage = document.getElementById(activePageId);
            const msgDiv = currentPage ? currentPage.querySelector('.message-display') : document.querySelector('#homePage .message-display');
            if (!msgDiv) return;

            msgDiv.innerText = message;
            msgDiv.className = 'message-display'; // Reset
            if (type === 'success') messageDiv.classList.add('success');
            else if (type === 'error') messageDiv.classList.add('error');
            else if (type === 'info') messageDiv.classList.add('info');
        }
    </script>
</body>
</html>
