<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Updated Version -->
    <title>Kero Assistance - Stock Transfer (v1.10 - URL Update 2)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

    <style>
        /* --- Keep your existing styles --- */
        body { font-family: 'Arial', sans-serif; background-color: #f0f8ff; margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; color: #424242; }
        /* Updated Version */
        .version { position: absolute; top: 5px; right: 10px; font-size: 0.8em; color: grey; }
        .container { background-color: #fff; border-radius: 12px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); padding: 30px; width: 85%; max-width: 900px; text-align: center; margin-top: 20px; }
        h1 { color: #1e88e5; margin-bottom: 20px; }
        #kero-assistance { font-size: 2em; }
        #stock-transfer { font-size: 1.5em; font-style: italic; }
        .section { margin-bottom: 25px; padding: 20px; border: 1px solid #bbdefb; border-radius: 8px; background-color: #e3f2fd; text-align: left; }
        .section h2 { text-align: center; margin-bottom: 15px; }
        .config-container { margin-bottom: 5px; text-align: center; color: #666; font-size: 0.9em;}
        .location-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .location-container select { width: 48%; padding: 10px; border: 1px solid #bbdefb; border-radius: 5px; box-sizing: border-box; font-size: 16px; }
        input[type="file"] { display: none; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #1e88e5; }
        button { background-color: #009688; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; margin: 10px 5px 5px 5px; transition: background-color 0.3s ease; display: inline-block; }
        .button-container { text-align: center; margin-top: 15px; }
        button:hover { background-color: #00796b; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        #processDownloadButton { font-size: 18px; padding: 16px 32px; background-color: #4caf50; display: block; width: 100%; margin-top: 20px; }
        #processDownloadButton:hover:enabled { background-color: #388e3c; }
        #message { margin-top: 20px; font-weight: bold; color: #d32f2f; text-align: center; min-height: 1.2em; }
        #message.success { color: #2e7d32; }
        #message.loading { color: #1e88e5; }
        .select2-container { width: 100% !important; }
        .select2-container.location-select-s2 { width: 48% !important; }
        .select2-selection { border: 1px solid #bbdefb !important; border-radius: 5px !important; padding: 6px 12px !important; height: auto !important; min-height: 40px; }
    </style>
</head>

<body>
    <!-- Updated Version -->
    <div class="version">v 1.10 - URL Update 2</div>

    <div id="appContent" class="container">
        <h1>
            <span id="kero-assistance">Kero Assistance</span>
            <br>
            <span id="stock-transfer">Stock Transfer Management</span>
        </h1>

        <!-- Simplified Configuration Section -->
        <div class="section">
             <h2>Processing Setup</h2>
             <div class="config-container">
                 <p>Database access is pre-configured via Google Apps Script.</p>
                 <p style="font-size: 0.8em">(Ensure corresponding GAS deployment has correct code & allows access by 'Anyone').</p>
             </div>
        </div>


        <div class="section">
            <h2>Quantity & Locations</h2>
            <div class="location-container">
                 <select id="locationFrom" class="location-select"> <option value="">Select Location From</option> <option value="جاردنز 101">جاردنز 101</option> <option value="تلال السخنة 102">تلال السخنة 102</option> <option value="ستيلا 103">ستيلا 103</option> <option value="الدبلو 104">الدبلو 104</option> <option value="تلال الساحل 105">تلال الساحل 105</option> <option value="سوان لك 106">سوان لك 106</option> <option value="كاسكادا 107">كاسكادا 107</option> <option value="لافيستا باي 108">لافيستا باي 108</option> <option value="راس الحكمة 109">راس الحكمة 109</option> <option value="لازوردي 110">لازوردي 110</option> <option value="النادي 111">النادي 111</option> <option value="زايد 112">زايد 112</option> <option value="القطامية 115">القطامية 115</option> <option value="مخزن بلبيس 201">مخزن بلبيс 201</option> <option value="مخزن الساحل 202">مخزن الساحل 202</option> </select>
                 <select id="locationTo" class="location-select"> <option value="">Select Location To</option> <option value="جاردنز 101">جاردنز 101</option> <option value="تلال السخنة 102">تلال السخنة 102</option> <option value="ستيلا 103">ستيلا 103</option> <option value="الدبلو 104">الدبلو 104</option> <option value="تلال الساحل 105">تلال الساحل 105</option> <option value="سوان لك 106">سوان لك 106</option> <option value="كاسكادا 107">كاسكادا 107</option> <option value="لافيستا باي 108">لافيستا باي 108</option> <option value="راس الحكمة 109">راس الحكمة 109</option> <option value="لازوردي 110">لازوردي 110</option> <option value="النادي 111">النادي 111</option> <option value="زايد 112">زايد 112</option> <option value="القطامية 115">القطامية 115</option> <option value="مخزن بلبيс 201">مخزن بلبيс 201</option> <option value="مخزن الساحل 202">مخزن الساحل 202</option> </select>
            </div>
             <hr style="border: 0; border-top: 1px solid #bbdefb; margin: 20px 0;">
             <label for="quantityFile">Upload Quantity File (.xlsx):</label>
            <input type="file" id="quantityFile" accept=".xlsx">
             <div class="button-container">
                <button id="uploadQuantityButton">Choose Quantity File</button>
                <button id="clearQuantity">Clear Quantity</button>
             </div>
        </div>

        <button id="processDownloadButton" disabled>Process Data and Download Results</button>

        <div id="message"></div>
    </div>

    <script>
        console.log("Kero Assistance App v1.10 Initializing..."); // Updated version

        // --- *** GAS URL Updated Here *** ---
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzWzrGrblfZ_z29QKCCAPiRtjGlHAVjrGf6yAg5AEmiNl374BEhOYI01wwdwmBBTN-P/exec";

        // Global state for quantity file processing
        let quantityInfo = {
            data: null,        // Holds the array of arrays from the sheet
            codeIndex: -1,     // Holds the 0-based index of the 'code' column
            quantityIndex: -1  // Holds the 0-based index of the 'quantity' column
        };

        // --- Helper Functions (Keep existing functions from v1.8) ---
        function showMessage(message, type = 'error') {
            const messageDiv = document.getElementById('message');
            messageDiv.innerText = message;
            messageDiv.className = type;
            if (type === 'error') {
                console.error("UI Message:", message);
            } else {
                console.log("UI Message:", message);
            }
        }

        function enableProcessButton() {
             const processButton = document.getElementById('processDownloadButton');
             // Check if the URL is valid (basic check: not empty) AND quantity data is loaded
             const isUrlSet = (GAS_URL && GAS_URL.startsWith("https://script.google.com/macros/"));
             const isQuantityReady = (quantityInfo.data && quantityInfo.codeIndex !== -1 && quantityInfo.quantityIndex !== -1);
             const canProcess = isUrlSet && isQuantityReady;
             processButton.disabled = !canProcess;
        }


        // --- Event Handlers (Keep existing functions from v1.8) ---
        function handleQuantityUpload(event) {
            console.log("handleQuantityUpload triggered.");
            const file = event.target.files[0];
            quantityInfo = { data: null, codeIndex: -1, quantityIndex: -1 }; // Reset state
            const uploadButton = document.getElementById('uploadQuantityButton');
            enableProcessButton(); // Disable button until processing succeeds

            if (!file) {
                 uploadButton.textContent = 'Choose Quantity File';
                 showMessage('Quantity file selection cancelled.', 'error');
                 console.warn("No file selected or selection cancelled.");
                return;
            }

            uploadButton.textContent = file.name;
            showMessage('Reading quantity file...', 'loading');
            console.log(`Attempting to read file: ${file.name} (Size: ${file.size} bytes)`);

            const reader = new FileReader();
            reader.onload = function(e) {
                console.log("FileReader onload event fired.");
                try {
                    const fileData = new Uint8Array(e.target.result);
                    console.log("File read into ArrayBuffer successfully.");

                    const workbook = XLSX.read(fileData, { type: 'array' });
                    console.log("XLSX workbook parsed.");
                    const sheetName = workbook.SheetNames[0];
                    if (!sheetName) throw new Error("No sheets found in the workbook.");
                    console.log(`Using first sheet: "${sheetName}"`);
                    const sheet = workbook.Sheets[sheetName];
                    if (!sheet) throw new Error(`Sheet "${sheetName}" could not be accessed.`);

                    // Parse sheet to array of arrays
                    const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
                    console.log(`Sheet parsed into ${jsonData?.length ?? 0} rows.`);
                    if (!jsonData || jsonData.length < 1) throw new Error('Quantity sheet is empty.');

                    // --- Find Headers ---
                    const headerRow = jsonData[0];
                    if (!headerRow) throw new Error('Quantity sheet header row is missing.');
                    console.log("Header row found:", headerRow);

                    const normalizedHeaders = headerRow.map(h => String(h).toLowerCase().trim());
                    const codeIdx = normalizedHeaders.indexOf('code');
                    const qtyIdx = normalizedHeaders.indexOf('quantity');
                    console.log(`Header Indices Found - code: ${codeIdx}, quantity: ${qtyIdx}`);

                    if (codeIdx === -1 || qtyIdx === -1) {
                        const missing = [];
                        if (codeIdx === -1) missing.push('code');
                        if (qtyIdx === -1) missing.push('quantity');
                        throw new Error(`Quantity file missing required header(s): [${missing.join(', ')}]. Found: [${normalizedHeaders.join(', ')}]`);
                    }

                    // Check for data rows
                    if (jsonData.length < 2) {
                         console.warn("Quantity file contains only headers. Processing will continue but may result in empty output.");
                    } else {
                         console.log(`Found ${jsonData.length - 1} data rows (excluding header).`);
                    }

                    // --- Store valid data ---
                    quantityInfo.data = jsonData;
                    quantityInfo.codeIndex = codeIdx;
                    quantityInfo.quantityIndex = qtyIdx;
                    console.info("Quantity data and header indices stored successfully.", quantityInfo);

                    showMessage(`Quantity file "${file.name}" processed. Headers OK.`, 'success');
                    enableProcessButton(); // Check if ready to process

                } catch (error) {
                    console.error('Error during quantity file processing:', error);
                    showMessage(`Error processing quantity file: ${error.message}`, 'error');
                    clearQuantityInternal(); // Clear state on error
                }
            };
            reader.onerror = function(error) {
                console.error('FileReader error:', error);
                showMessage(`Error reading quantity file: ${error.message}`, 'error');
                clearQuantityInternal();
            };
            reader.readAsArrayBuffer(file);
        }

        function clearQuantityInternal() {
            document.getElementById('quantityFile').value = ''; // Clear file input selection
            quantityInfo = { data: null, codeIndex: -1, quantityIndex: -1 };
            document.getElementById('uploadQuantityButton').textContent = 'Choose Quantity File';
            enableProcessButton();
            console.log("Quantity data cleared internally.");
        }

        function clearQuantity() {
            clearQuantityInternal();
            showMessage('Quantity data cleared.', 'success');
            console.log("Quantity clear button clicked.");
        }

        async function processDataAndDownload() {
            console.log("processDataAndDownload triggered.");
            const processButton = document.getElementById('processDownloadButton');
            processButton.disabled = true; // Disable button during processing

            // --- Get User Inputs ---
            const locationFromValue = document.getElementById('locationFrom').value;
            const locationToValue = document.getElementById('locationTo').value;
            const gasUrl = GAS_URL; // Use the constant

            // --- 1. Input Validations ---
            console.log("Step 1: Validating inputs...");
            if (!locationFromValue || !locationToValue) {
                showMessage('Please select both "Location From" and "Location To".'); processButton.disabled = false; return;
            }
            console.log(`Locations selected: From - ${locationFromValue}, To - ${locationToValue}`);

             if (!gasUrl || !gasUrl.startsWith("https://script.google.com/macros/")) { // Basic check
                 showMessage('CRITICAL ERROR: Google Apps Script URL is not configured correctly!', 'error');
                 console.error("GAS_URL constant is invalid!");
                 return; // Keep button disabled
             }
             console.log("GAS URL constant appears valid.");

            if (!quantityInfo.data || quantityInfo.codeIndex === -1 || quantityInfo.quantityIndex === -1) {
                showMessage('Please upload a valid quantity data file.'); processButton.disabled = false; return;
            }
            console.log("Quantity data appears valid.");
            console.log("Input validation successful.");
            showMessage('Processing... Step 1: Extracting codes.', 'loading');


            try {
                // --- 2. Extract Unique Codes ---
                console.log("Step 2: Extracting unique codes from quantity data...");
                const uniqueCodes = new Set();
                // Start from row 1 (index 1) to skip header
                for (let i = 1; i < quantityInfo.data.length; i++) {
                    const code = String(quantityInfo.data[i][quantityInfo.codeIndex] ?? '').trim();
                    if (code) {
                        uniqueCodes.add(code);
                    }
                }
                const codesToLookup = Array.from(uniqueCodes);
                console.info(`Found ${codesToLookup.length} unique codes to look up.`);

                if (codesToLookup.length === 0) {
                     showMessage('No valid codes found in the quantity file data rows.', 'error');
                     enableProcessButton(); // Re-enable button
                     return;
                }

                // --- 3. Call Google Apps Script ---
                console.log(`Step 3: Calling Google Apps Script at ${gasUrl.substring(0, 50)}... with ${codesToLookup.length} codes.`);
                showMessage(`Processing... Step 2: Fetching data for ${codesToLookup.length} codes...`, 'loading');
                const requestPayload = { codes: codesToLookup };

                const response = await fetch(gasUrl, {
                    method: 'POST', mode: 'cors', cache: 'no-cache',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(requestPayload), redirect: 'follow'
                });
                console.log(`GAS Response Status: ${response.status}`);

                if (!response.ok) {
                    let errorText = `GAS request failed: ${response.status}`;
                    try {
                        const text = await response.text();
                        console.error("GAS Error Response Text:", text);
                        errorText += ` - ${text}`;
                    } catch (e) { console.warn("Could not read GAS error response text.", e)}
                    throw new Error(errorText.substring(0, 300)); // Limit length
                }
                console.log("GAS fetch successful (Network level).");

                const gasResult = await response.json();
                console.log("GAS response parsed as JSON.");

                // Check for errors reported by the GAS script itself
                if (!gasResult || typeof gasResult !== 'object') throw new Error("Invalid JSON structure received from GAS.");
                if (gasResult.errors && gasResult.errors.length > 0) {
                    console.error("Errors reported by GAS script:", gasResult.errors);
                    throw new Error(`Error from GAS: ${gasResult.errors.join(', ')}`);
                }
                if (!gasResult.data) throw new Error("GAS response missing expected 'data' field.");
                console.info("GAS script executed successfully, received data object.");


                // --- 4. Create Lookup Map ---
                console.log("Step 4: Creating lookup map from GAS data...");
                showMessage(`Processing... Step 3: Preparing results...`, 'loading');
                const databaseMap = new Map(Object.entries(gasResult.data));
                console.log(`Created map with ${databaseMap.size} entries from GAS response.`);


                // --- 5. Process Quantity Data Against Map ---
                console.log("Step 5: Merging quantity data with GAS results...");
                const results = [];
                const unmatched = [];
                for (let i = 1; i < quantityInfo.data.length; i++) { // Start i=1 to skip header
                    const row = quantityInfo.data[i];
                    const code = String(row[quantityInfo.codeIndex] ?? '').trim();
                    const quantity = row[quantityInfo.quantityIndex]; // Get quantity using its index
                    if (!code) continue; // Skip if no code in this row

                    const dbEntry = databaseMap.get(code);
                    if (dbEntry) {
                        results.push({ Code: code, Barcode: dbEntry.barcode, Name: dbEntry.name, Quantity: quantity ?? 0 });
                    } else {
                        unmatched.push({ Code: code, Quantity: quantity ?? 0 });
                    }
                }
                console.info(`Processing complete. Matched: ${results.length}, Unmatched: ${unmatched.length}`);


                // --- 6. Create Excel Workbook ---
                console.log("Step 6: Generating Excel file...");
                const wb = XLSX.utils.book_new();

                // Results Sheet
                const resultsHeader = ["Code", "Barcode", "Name", "Quantity"];
                const resultsSheetData = [resultsHeader, ...results.map(item => [item.Code, item.Barcode, item.Name, item.Quantity])];
                const resultsSheet = XLSX.utils.aoa_to_sheet(resultsSheetData);
                resultsSheet['!cols'] = [{ wch: 15 }, { wch: 20 }, { wch: 50 }, { wch: 10 }]; // Column widths
                XLSX.utils.book_append_sheet(wb, resultsSheet, "Results");
                console.log(`Added "Results" sheet with ${results.length} data rows.`);

                // Unmatched Sheet (only if needed)
                if (unmatched.length > 0) {
                     const unmatchedHeader = ["Code", "Quantity"];
                     const unmatchedSheetData = [unmatchedHeader, ...unmatched.map(item => [item.Code, item.Quantity])];
                    const unmatchedSheet = XLSX.utils.aoa_to_sheet(unmatchedSheetData);
                     unmatchedSheet['!cols'] = [{ wch: 15 }, { wch: 10 }]; // Column widths
                    XLSX.utils.book_append_sheet(wb, unmatchedSheet, "Unmatched");
                    console.log(`Added "Unmatched" sheet with ${unmatched.length} data rows.`);
                } else {
                     console.log("No unmatched items, skipping 'Unmatched' sheet.");
                }

                // --- 7. Generate Filename and Download ---
                console.log("Step 7: Triggering download...");
                const currentDate = new Date();
                const formattedDate = `${currentDate.getFullYear()}-${('0' + (currentDate.getMonth() + 1)).slice(-2)}-${('0' + currentDate.getDate()).slice(-2)}`;
                const filename = `StockTransfer من ${locationFromValue} الي ${locationToValue} ${formattedDate}.xlsx`;
                XLSX.writeFile(wb, filename);
                console.log(`Excel file "${filename}" download initiated.`);

                // --- Cleanup and Final Message ---
                clearQuantityInternal(); // Clear quantity data after successful processing
                showMessage(`Processed ${results.length} matched, ${unmatched.length} unmatched. Downloaded!`, 'success');
                console.info("processDataAndDownload finished successfully.");

            } catch (error) {
                // Log any error that occurred during the try block
                console.error('Error during processDataAndDownload:', error);
                showMessage(`Error: ${error.message}`, 'error'); // Display error to user
            } finally {
                // This block always runs, whether try succeeded or failed
                enableProcessButton(); // Re-enable the button
                console.log("processDataAndDownload finished (try/catch/finally complete).");
            }
        }


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM fully loaded and parsed.");

            console.log("Initializing Select2 dropdowns...");
            try {
                // Corrected Select2 initialization
                $('.location-select').select2({
                    placeholder: "Select a Location",
                    allowClear: true
                });
                console.log("Select2 initialized successfully.");
            } catch (error) {
                console.error("Error initializing Select2:", error);
                showMessage("Error setting up dropdowns. Please refresh.", "error");
            }

            console.log("Attaching event listeners...");
            document.getElementById('uploadQuantityButton').addEventListener('click', () => {
                console.log("Upload Quantity Button clicked, triggering file input.");
                document.getElementById('quantityFile').click();
            });
            document.getElementById('quantityFile').addEventListener('change', handleQuantityUpload);
            document.getElementById('clearQuantity').addEventListener('click', clearQuantity);
            document.getElementById('processDownloadButton').addEventListener('click', processDataAndDownload);
            console.log("Event listeners attached.");

            // Final check for GAS URL configuration on load
             if (!GAS_URL || !GAS_URL.startsWith("https://script.google.com/macros/")) {
                 console.error("Configuration Error: GAS_URL constant is invalid!");
                 showMessage("Configuration Error: App requires setup (GAS URL invalid).", "error");
             } else {
                 console.log("GAS_URL constant is set:", GAS_URL.substring(0,50)+"..."); // Log start of URL
             }
            enableProcessButton(); // Initial check for button state
        });

    </script>

</body>
</html>
