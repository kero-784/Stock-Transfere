<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kero Assistance - Stock Transfer Management v2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Using Select2 is optional now if locations are fixed, but kept for potential future use -->
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" /> -->
    <!-- <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script> -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"> <!-- Material Icons -->


    <style>
        /* --- Basic Resets & Body --- */
        body, html {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', 'Arial', sans-serif; /* More modern font */
            background-color: #f4f6f8; /* Lighter background */
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1000px; /* Slightly wider */
            margin: 25px auto;
            padding: 25px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        /* --- Headings & Titles --- */
        h1 {
            text-align: center;
            color: #1e88e5; /* Keep brand color */
            margin-bottom: 25px;
            font-weight: 500;
        }
        #kero-assistance { font-size: 1.8em; }
        #stock-transfer { font-size: 1.3em; font-style: italic; color: #555; }

        h2 {
            font-size: 1.25rem;
            color: #3f51b5; /* Material Design primary */
            margin-top: 0;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 500;
        }

        /* --- Sections --- */
        .section {
            background-color: #ffffff; /* White background for sections */
            border: 1px solid #e0e0e0; /* Lighter border */
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); /* Subtle shadow */
        }

        /* --- Inputs & Selects --- */
         input[type="file"], input[type="text"], input[type="password"], select {
            padding: 10px 12px;
            margin: 5px 0 10px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.95rem;
            box-sizing: border-box;
            width: 100%;
            transition: border-color 0.2s ease;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #3f51b5;
            box-shadow: 0 0 0 1px #3f51b5;
        }
        input[type="file"] {
            border: none; /* Cleaner look for file input */
            padding: 10px 0;
        }

        .location-container {
            display: flex;
            gap: 15px; /* Spacing between selects */
            margin-bottom: 15px;
        }
        .location-container select {
             width: 50%; /* Each takes half */
        }

        /* --- Buttons --- */
        button {
            padding: 10px 16px;
            margin: 5px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            color: white;
            background-color: #3F51B5; /* Material primary */
            font-size: 0.9rem;
            text-transform: uppercase;
            box-shadow: 0 2px 2px 0 rgba(0,0,0,0.14), 0 3px 1px -2px rgba(0,0,0,0.12), 0 1px 5px 0 rgba(0,0,0,0.2);
            transition: box-shadow 0.3s ease, background-color 0.3s ease;
            display: inline-flex; /* Align icon and text */
            align-items: center;
            justify-content: center;
            gap: 8px; /* Space between icon and text */
            vertical-align: middle; /* Align with text if needed */
        }
        button:hover {
            box-shadow: 0 4px 5px 0 rgba(0,0,0,0.2), 0 1px 10px 0 rgba(0,0,0,0.12), 0 2px 4px -1px rgba(0,0,0,0.2);
            background-color: #303F9F; /* Darker primary */
        }
        button:disabled {
            background-color: #bdbdbd;
            box-shadow: none;
            cursor: not-allowed;
            color: #757575;
        }
        button:disabled .material-icons {
            color: #757575;
        }

        .secondary-button { /* For less prominent actions */
            background-color: #f5f5f5;
            color: #555;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .secondary-button:hover {
            background-color: #eeeeee;
            color: #333;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        #processDownloadButton { /* Highlight main action */
            background-color: #4CAF50; /* Green */
            font-size: 1rem; /* Slightly larger */
            padding: 12px 24px;
        }
        #processDownloadButton:hover {
            background-color: #388E3C; /* Darker green */
        }

        .danger-button { /* For destructive actions */
            background-color: #f44336; /* Red */
        }
        .danger-button:hover {
            background-color: #d32f2f; /* Darker red */
        }

        /* --- Messages & Status --- */
        #message {
            margin-top: 20px;
            padding: 12px;
            border-radius: 4px;
            font-weight: 500;
            text-align: left;
        }
        #message.success {
            background-color: #e8f5e9; /* Light green */
            color: #2e7d32; /* Dark green */
            border: 1px solid #a5d6a7;
        }
        #message.error {
            background-color: #ffebee; /* Light red */
            color: #c62828; /* Dark red */
            border: 1px solid #ef9a9a;
        }
        #message.info {
            background-color: #e3f2fd; /* Light blue */
            color: #1565c0; /* Dark blue */
            border: 1px solid #90caf9;
        }

        #dbStatus {
             font-size: 0.9em;
             color: #666;
             margin-top: 10px;
             text-align: left;
        }

        /* --- Table Styles (for Log) --- */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-radius: 4px;
            overflow: hidden; /* Ensures border-radius clips content */
            border: 1px solid #e0e0e0;
        }
        th, td {
            padding: 10px 12px;
            text-align: left;
            font-size: 0.85rem;
            border-bottom: 1px solid #e0e0e0;
            vertical-align: middle;
        }
        th {
            background-color: #f5f5f5; /* Light grey header */
            color: #757575; /* Muted text */
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        tr:last-child td {
            border-bottom: none;
        }
        tr:hover {
             background-color: #f9f9f9; /* Subtle hover */
        }
        td button { /* Style buttons inside table cells */
            padding: 4px 8px;
            font-size: 0.8rem;
            margin: 0 2px;
        }


        /* --- Version & Other --- */
        .version {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 0.8em;
            color: #aaa;
        }
        .material-icons {
            vertical-align: middle;
            font-size: 1.1em; /* Adjust icon size */
        }

        /* --- Responsive --- */
        @media (max-width: 768px) {
            .container {
                width: 95%;
                padding: 20px;
            }
            .location-container {
                flex-direction: column;
                gap: 10px;
            }
            .location-container select {
                width: 100%;
            }
            h1 { font-size: 1.5em; }
            h2 { font-size: 1.1em; }
            button { padding: 9px 14px; font-size: 0.85rem; }
            #processDownloadButton { padding: 10px 20px; font-size: 0.95rem; }
            th, td { font-size: 0.8rem; padding: 8px 10px;}
        }
         @media (max-width: 480px) {
            button { width: 100%; margin: 5px 0; } /* Stack buttons */
            .section { padding: 15px; }
            h1 { font-size: 1.3em; }
             #kero-assistance { font-size: 1.5em; }
             #stock-transfer { font-size: 1.1em; }
             th, td { font-size: 0.75rem; padding: 6px 8px;}
        }

    </style>
</head>

<body>
    <div class="version">v 2.0 - LocalStorage/GSheet</div>

    <div id="appContent" class="container">
        <h1>
            <span id="kero-assistance">Kero Assistance</span>
            <br>
            <span id="stock-transfer">Stock Transfer Management</span>
        </h1>

        <div class="section">
            <h2>Database Management</h2>
            <!-- Provide the *published* CSV link for your Google Sheet -->
            <input type="text" id="googleSheetUrl" placeholder="Enter Google Sheet CSV URL (Optional - Overrides Default)" value="https://docs.google.com/spreadsheets/d/e/YOUR_PUBLISHED_SHEET_ID/pub?output=csv">
             <button id="fetchDbButton"><span class="material-icons">cloud_download</span>Fetch DB from Sheet</button>
            <hr style="margin: 15px 0; border: none; border-top: 1px solid #eee;">
            <label for="databaseFile" style="display:block; text-align: left; margin-bottom: 5px; font-size: 0.9em; color: #555;">Or Upload Database File (Alternative):</label>
            <input type="file" id="databaseFile" accept=".xlsx">
            <!-- Upload button removed, file input change triggers upload directly -->
            <button id="clearDatabaseButton" class="secondary-button danger-button"><span class="material-icons">delete_sweep</span>Clear Stored DB</button>
            <div id="dbStatus">Database Status: Not Loaded</div>
        </div>

        <div class="section">
            <h2>Initiate New Transfer</h2>

            <div class="location-container">
              <select id="locationFrom" class="location-select">
                  <option value="">Select Location From</option>
                  <option value="جاردنز 101">جاردنز 101</option>
                  <option value="تلال السخنة 102">تلال السخنة 102</option>
                  <option value="ستيلا 103">ستيلا 103</option>
                  <option value="الدبلو 104">الدبلو 104</option>
                  <option value="تلال الساحل 105">تلال الساحل 105</option>
                  <option value="سوان لك 106">سوان لك 106</option>
                  <option value="كاسكادا 107">كاسكادا 107</option>
                  <option value="لافيستا باي 108">لافيستا باي 108</option>
                  <option value="راس الحكمة 109">راس الحكمة 109</option>
                  <option value="لازوردي 110">لازوردي 110</option>
                  <option value="النادي 111">النادي 111</option>
                  <option value="زايد 112">زايد 112</option>
                  <option value="القطامية 115">القطامية 115</option>
                  <option value="مخزن بلبيس 201">مخزن بلبيس 201</option>
                  <option value="مخزن الساحل 202">مخزن الساحل 202</option>
              </select>

              <select id="locationTo" class="location-select">
                  <option value="">Select Location To</option>
                    <option value="جاردنز 101">جاردنز 101</option>
                    <option value="تلال السخنة 102">تلال السخنة 102</option>
                    <option value="ستيلا 103">ستيلا 103</option>
                    <option value="الدبلو 104">الدبلو 104</option>
                    <option value="تلال الساحل 105">تلال الساحل 105</option>
                    <option value="سوان لك 106">سوان لك 106</option>
                    <option value="كاسكادا 107">كاسكادا 107</option>
                    <option value="لافيستا باي 108">لافيستا باي 108</option>
                    <option value="راس الحكمة 109">راس الحكمة 109</option>
                    <option value="لازوردي 110">لازوردي 110</option>
                    <option value="النادي 111">النادي 111</option>
                    <option value="زايد 112">زايد 112</option>
                    <option value="القطامية 115">القطامية 115</option>
                    <option value="مخزن بلبيس 201">مخزن بلبيس 201</option>
                    <option value="مخزن الساحل 202">مخزن الساحل 202</option>
              </select>
            </div>

            <label for="quantityFile" style="display:block; text-align: left; margin-bottom: 5px; font-size: 0.9em; color: #555;">Upload Quantity File for this Transfer:</label>
            <input type="file" id="quantityFile" accept=".xlsx">
            <!-- Upload button removed, file input change triggers upload directly -->
            <button id="clearQuantityButton" class="secondary-button"><span class="material-icons">clear</span>Clear Quantity File</button>
        </div>

        <button id="processDownloadButton" disabled><span class="material-icons">play_arrow</span>Process Transfer & Download Results</button>

        <div id="message"></div> <!-- For user feedback -->

        <div class="section">
            <h2>Transfer Log</h2>
             <button id="clearLogButton" class="secondary-button danger-button"><span class="material-icons">history_toggle_off</span>Clear Log</button>
             <button id="exportLogButton" class="secondary-button"><span class="material-icons">download</span>Export Full Log</button>
            <table id="transferLogTable">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>From</th>
                        <th>To</th>
                        <th>Matched</th>
                        <th>Unmatched</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Log entries will be added here -->
                </tbody>
            </table>
        </div>

    </div>

    <script>
        // --- Global Variables ---
        let databaseData = null; // Will hold array of arrays [[header], [row1], [row2]...]
        let databaseHeaderMap = {}; // Maps header name to column index
        let quantityData = null; // Holds the currently loaded quantity file data
        let transferLog = []; // Holds history of transfers [{timestamp, from, to, results, unmatched}, ...]
        // Default Google Sheet URL (Replace YOUR_PUBLISHED_SHEET_ID with your actual sheet ID)
        const DEFAULT_GOOGLE_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQNrRFFRPe_jrOrDZM58gRqxfsA0deD60_q2jkA7XJRRfJQ7IiBdIqNDN7JdMawjw/pub?output=csv";
        const REQUIRED_DB_HEADERS = ['code', 'barcode', 'name'];
        const REQUIRED_QTY_HEADERS = ['code', 'quantity'];

        // --- DOM Elements ---
        const googleSheetUrlInput = document.getElementById('googleSheetUrl');
        const fetchDbButton = document.getElementById('fetchDbButton');
        const databaseFileInput = document.getElementById('databaseFile');
        const clearDatabaseButton = document.getElementById('clearDatabaseButton');
        const dbStatusDiv = document.getElementById('dbStatus');
        const locationFromSelect = document.getElementById('locationFrom');
        const locationToSelect = document.getElementById('locationTo');
        const quantityFileInput = document.getElementById('quantityFile');
        const clearQuantityButton = document.getElementById('clearQuantityButton');
        const processDownloadButton = document.getElementById('processDownloadButton');
        const messageDiv = document.getElementById('message');
        const transferLogTableBody = document.getElementById('transferLogTable').querySelector('tbody');
        const clearLogButton = document.getElementById('clearLogButton');
        const exportLogButton = document.getElementById('exportLogButton');


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', initializeData);

        async function initializeData() {
            showMessage('Initializing application...', 'info');
            googleSheetUrlInput.value = localStorage.getItem('googleSheetUrl') || DEFAULT_GOOGLE_SHEET_URL;

            // Load existing data from Local Storage
            loadFromLocalStorage();

            // Attempt to fetch DB from stored/default URL automatically
            if (!databaseData) { // Only fetch if not already loaded from LS
                 await fetchDatabaseFromGoogleSheet();
             } else {
                 updateDbStatus(true, `Loaded ${databaseData.length -1} items from Local Storage.`);
                 checkProcessButtonState(); // Check if processing is possible
             }

            renderTransferLog();
            showMessage('Initialization complete. Ready.', 'success');
        }

        function loadFromLocalStorage() {
            const storedDb = localStorage.getItem('databaseData');
            const storedMap = localStorage.getItem('databaseHeaderMap');
            const storedLog = localStorage.getItem('transferLog');

            if (storedDb && storedMap) {
                try {
                    databaseData = JSON.parse(storedDb);
                    databaseHeaderMap = JSON.parse(storedMap);
                    if (!Array.isArray(databaseData) || typeof databaseHeaderMap !== 'object') {
                         throw new Error("Invalid data format in Local Storage.");
                    }
                    console.log("Database loaded from Local Storage.");
                } catch (e) {
                    console.error("Error parsing database from Local Storage:", e);
                    localStorage.removeItem('databaseData');
                    localStorage.removeItem('databaseHeaderMap');
                    databaseData = null;
                    databaseHeaderMap = {};
                }
            }

            if (storedLog) {
                try {
                    transferLog = JSON.parse(storedLog);
                     if (!Array.isArray(transferLog)) {
                        throw new Error("Invalid log format in Local Storage.");
                    }
                    console.log("Transfer log loaded from Local Storage.");
                } catch (e) {
                    console.error("Error parsing transfer log from Local Storage:", e);
                    localStorage.removeItem('transferLog');
                    transferLog = [];
                }
            }
            checkProcessButtonState(); // Update button state based on loaded data
        }

        // --- Event Listeners ---
        fetchDbButton.addEventListener('click', fetchDatabaseFromGoogleSheet);
        databaseFileInput.addEventListener('change', handleDatabaseUpload); // Trigger on file selection
        clearDatabaseButton.addEventListener('click', clearDatabase);
        quantityFileInput.addEventListener('change', handleQuantityUpload); // Trigger on file selection
        clearQuantityButton.addEventListener('click', clearQuantity);
        processDownloadButton.addEventListener('click', processDataAndDownload);
        clearLogButton.addEventListener('click', clearTransferLog);
        exportLogButton.addEventListener('click', exportTransferLog);
        googleSheetUrlInput.addEventListener('change', () => {
             localStorage.setItem('googleSheetUrl', googleSheetUrlInput.value); // Save URL on change
        });


        // --- Database Handling ---

        async function fetchDatabaseFromGoogleSheet() {
            const url = googleSheetUrlInput.value.trim();
            if (!url || !url.includes('/pub?output=csv')) {
                showMessage('Please provide a valid Google Sheet *published* CSV URL.', 'error');
                updateDbStatus(false, 'Invalid URL provided.');
                return;
            }
            localStorage.setItem('googleSheetUrl', url); // Save valid URL
            showMessage('Fetching database from Google Sheet...', 'info');
            updateDbStatus(false, 'Fetching...');
            fetchDbButton.disabled = true;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                parseAndStoreDatabase(csvText, "Google Sheet");

            } catch (error) {
                console.error("Error fetching data from Google Sheet:", error);
                showMessage(`Failed to load database from Google Sheet: ${error.message}. Try uploading a file.`, 'error');
                updateDbStatus(false, `Fetch failed: ${error.message}`);
                 checkProcessButtonState(); // Re-enable process button if DB loaded previously
            } finally {
                 fetchDbButton.disabled = false;
             }
        }

         function handleDatabaseUpload(event) {
             const file = event.target.files[0];
             if (!file) return;

             showMessage('Reading database file...', 'info');
             updateDbStatus(false, 'Reading file...');
             const reader = new FileReader();

             reader.onload = function(e) {
                 try {
                     const data = new Uint8Array(e.target.result);
                     const workbook = XLSX.read(data, { type: 'array' });
                     const sheetName = workbook.SheetNames[0];
                     const worksheet = workbook.Sheets[sheetName];
                     if (!worksheet) throw new Error("Sheet not found in the Excel file.");

                     // Convert sheet to CSV text to reuse parsing logic
                     const csvText = XLSX.utils.sheet_to_csv(worksheet);
                     parseAndStoreDatabase(csvText, `File: ${file.name}`);

                 } catch (error) {
                     console.error("Error processing database file:", error);
                     showMessage(`Error processing database file: ${error.message}`, 'error');
                     updateDbStatus(false, 'File processing error.');
                      checkProcessButtonState();
                     databaseFileInput.value = ''; // Clear input on error
                 }
             };
             reader.onerror = function(error) {
                 showMessage(`Error reading file: ${error.message}`, 'error');
                 updateDbStatus(false, 'File reading error.');
                 databaseFileInput.value = ''; // Clear input on error
                 checkProcessButtonState();
             };
             reader.readAsArrayBuffer(file);
         }


        function parseAndStoreDatabase(csvText, source) {
            try {
                const lines = csvText.trim().split('\n');
                if (lines.length < 1) throw new Error("CSV data is empty.");

                // Parse headers
                const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                const tempHeaderMap = {};
                headers.forEach((header, index) => {
                    tempHeaderMap[header] = index;
                });

                // Validate required headers
                const missingHeaders = REQUIRED_DB_HEADERS.filter(reqH => !(reqH in tempHeaderMap));
                if (missingHeaders.length > 0) {
                    throw new Error(`Missing required database headers: ${missingHeaders.join(', ')}`);
                }

                // Parse data rows
                const tempData = [headers]; // Start with headers as first row
                for (let i = 1; i < lines.length; i++) {
                    // Basic CSV parsing (doesn't handle quotes perfectly, use a library for complex CSV)
                    const row = lines[i].split(',').map(cell => cell.trim());
                     if (row.length === headers.length && row.some(cell => cell !== '')) { // Ensure same number of columns and not empty
                         tempData.push(row);
                     }
                }

                 if (tempData.length <= 1) {
                     throw new Error("No data rows found in the database source.");
                 }

                // Success - Update global variables and Local Storage
                databaseData = tempData;
                databaseHeaderMap = tempHeaderMap;

                localStorage.setItem('databaseData', JSON.stringify(databaseData));
                localStorage.setItem('databaseHeaderMap', JSON.stringify(databaseHeaderMap));

                const itemCount = databaseData.length - 1; // Exclude header row
                showMessage(`Database loaded successfully from ${source} (${itemCount} items).`, 'success');
                updateDbStatus(true, `Loaded ${itemCount} items from ${source}.`);
                databaseFileInput.value = ''; // Clear file input after successful processing
                checkProcessButtonState();

            } catch (error) {
                 console.error("Error parsing database data:", error);
                 showMessage(`Error parsing database: ${error.message}`, 'error');
                 updateDbStatus(false, `Parsing error: ${error.message}`);
                 databaseData = null; // Reset on error
                 databaseHeaderMap = {};
                 localStorage.removeItem('databaseData');
                 localStorage.removeItem('databaseHeaderMap');
                  checkProcessButtonState();
            }
        }


        function clearDatabase() {
            if (confirm("Are you sure you want to clear the stored database? You will need to fetch or upload it again.")) {
                databaseData = null;
                databaseHeaderMap = {};
                localStorage.removeItem('databaseData');
                localStorage.removeItem('databaseHeaderMap');
                showMessage('Stored database cleared.', 'info');
                updateDbStatus(false, 'Cleared.');
                 checkProcessButtonState();
            }
        }

        function updateDbStatus(isLoaded, message) {
             dbStatusDiv.textContent = `Database Status: ${isLoaded ? 'Loaded' : 'Not Loaded'} - ${message}`;
             dbStatusDiv.style.color = isLoaded ? 'green' : 'red';
        }


        // --- Quantity Handling ---
        function handleQuantityUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                quantityData = null; // Reset if no file selected
                 checkProcessButtonState();
                return;
            }

            showMessage('Reading quantity file...', 'info');
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    if (!worksheet) throw new Error("Sheet not found in quantity file.");

                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 }); // Read as array of arrays

                     if (jsonData.length < 1) throw new Error("Quantity sheet is empty.");

                     const headers = jsonData[0].map(h => String(h).trim().toLowerCase());

                    // Validate required headers
                     const missingHeaders = REQUIRED_QTY_HEADERS.filter(reqH => !headers.includes(reqH));
                     if (missingHeaders.length > 0) {
                        throw new Error(`Missing required quantity headers: ${missingHeaders.join(', ')}`);
                     }

                    // Filter out empty rows
                     quantityData = jsonData.filter((row, index) => index === 0 || row.some(cell => cell !== null && cell !== ''));

                    if (quantityData.length <= 1) { // Only header row left
                        throw new Error("No valid data rows found in the quantity file.");
                    }

                    showMessage(`Quantity file "${file.name}" loaded (${quantityData.length - 1} items). Ready to process.`, 'success');
                     checkProcessButtonState();

                } catch (error) {
                    console.error("Error processing quantity file:", error);
                    showMessage(`Error processing quantity file: ${error.message}`, 'error');
                    quantityData = null;
                    quantityFileInput.value = ''; // Clear input on error
                    checkProcessButtonState();
                }
            };
             reader.onerror = function(error) {
                 showMessage(`Error reading quantity file: ${error.message}`, 'error');
                 quantityData = null;
                 quantityFileInput.value = '';
                 checkProcessButtonState();
             };
            reader.readAsArrayBuffer(file);
        }


        function clearQuantity() {
            quantityData = null;
            quantityFileInput.value = ''; // Clear the file input visually
            showMessage('Quantity file selection cleared.', 'info');
            checkProcessButtonState();
        }


        // --- Processing & Downloading ---

         function checkProcessButtonState() {
             // Enable button only if DB is loaded AND a quantity file is loaded
             const dbLoaded = databaseData && databaseData.length > 1;
             const qtyLoaded = quantityData && quantityData.length > 1;
             processDownloadButton.disabled = !(dbLoaded && qtyLoaded);

            // Optionally provide more specific feedback
             if (!dbLoaded) {
                 updateDbStatus(false, 'Database not loaded.');
             }
             if (!qtyLoaded && dbLoaded) {
                 // Don't overwrite DB status if it's okay
             }
         }

        function processDataAndDownload() {
            const locationFromValue = locationFromSelect.value;
            const locationToValue = locationToSelect.value;

            // Re-validate everything before processing
            if (!databaseData || databaseData.length <= 1) {
                showMessage('Database is not loaded. Please fetch or upload it first.', 'error');
                return;
            }
            if (!quantityData || quantityData.length <= 1) {
                showMessage('Quantity file is not loaded for this transfer. Please upload it.', 'error');
                return;
            }
            if (!locationFromValue || !locationToValue) {
                showMessage('Please select both "Location From" and "Location To".', 'error');
                return;
            }
             if (locationFromValue === locationToValue) {
                 showMessage('Please select different "Location From" and "Location To".', 'error');
                 return;
             }

            showMessage('Processing transfer...', 'info');
            processDownloadButton.disabled = true; // Disable during processing

            try {
                const results = [];
                const unmatched = [];

                // Find column indices in the loaded databaseData
                const codeColDb = databaseHeaderMap['code'];
                const barcodeColDb = databaseHeaderMap['barcode'];
                const nameColDb = databaseHeaderMap['name'];

                // Find column indices in the loaded quantityData
                const qtyHeaders = quantityData[0].map(h => String(h).trim().toLowerCase());
                const codeColQty = qtyHeaders.indexOf('code');
                const quantityColQty = qtyHeaders.indexOf('quantity');

                // Create a lookup map from the database for faster searching
                const dbLookup = new Map();
                for (let j = 1; j < databaseData.length; j++) { // Start from 1 to skip header
                    const dbRow = databaseData[j];
                    const dbCode = String(dbRow[codeColDb]).trim();
                    if (dbCode) {
                         // Store the entire row or relevant parts
                        dbLookup.set(dbCode, {
                            barcode: dbRow[barcodeColDb],
                            name: dbRow[nameColDb]
                            // Add other DB columns if needed in results
                        });
                    }
                }

                // Process quantity data
                for (let i = 1; i < quantityData.length; i++) { // Start from 1 to skip header
                    const quantityRow = quantityData[i];
                    const code = String(quantityRow[codeColQty]).trim();
                    const quantity = quantityRow[quantityColQty]; // Keep original type if possible

                    if (!code || quantity === undefined || quantity === null || quantity === '') continue; // Skip rows without code or quantity

                    const matchedDbItem = dbLookup.get(code);

                    if (matchedDbItem) {
                        results.push({
                            Code: code,
                            Barcode: matchedDbItem.barcode,
                            Name: matchedDbItem.name,
                            Quantity: quantity
                        });
                    } else {
                        unmatched.push({
                            Code: code,
                            Quantity: quantity
                        });
                    }
                }

                // --- Generate Excel File ---
                const wb = XLSX.utils.book_new();

                // Results Sheet
                const resultsHeader = ["Code", "Barcode", "Name", "Quantity"];
                const resultsMappedData = results.map(item => [item.Code, item.Barcode, item.Name, item.Quantity]);
                resultsMappedData.unshift(resultsHeader); // Add header row
                const resultsSheet = XLSX.utils.aoa_to_sheet(resultsMappedData);
                resultsSheet['!cols'] = [{ wch: 15 }, { wch: 20 }, { wch: 50 }, { wch: 10 }]; // Column widths
                XLSX.utils.book_append_sheet(wb, resultsSheet, "Results");

                // Unmatched Sheet
                if (unmatched.length > 0) {
                    const unmatchedHeader = ["Code", "Quantity"];
                    const unmatchedMappedData = unmatched.map(item => [item.Code, item.Quantity]);
                    unmatchedMappedData.unshift(unmatchedHeader);
                    const unmatchedSheet = XLSX.utils.aoa_to_sheet(unmatchedMappedData);
                     unmatchedSheet['!cols'] = [{ wch: 15 }, { wch: 10 }];
                    XLSX.utils.book_append_sheet(wb, unmatchedSheet, "Unmatched");
                }

                // Generate filename
                const now = new Date();
                // Use local date format, replace slashes/colons for filename safety
                 const formattedDate = now.toLocaleDateString().replace(/\//g, '-');
                 const formattedTime = now.toLocaleTimeString().replace(/:/g, '-').replace(/\s/g, '_');
                const filename = `Transfer_${locationFromValue}_to_${locationToValue}_${formattedDate}_${formattedTime}.xlsx`;

                // Trigger download
                XLSX.writeFile(wb, filename);

                // --- Log the Transfer ---
                logTransfer(locationFromValue, locationToValue, results, unmatched);

                // --- Cleanup and Feedback ---
                clearQuantity(); // Clear the quantity file input and data
                showMessage(`Transfer processed. Found ${results.length} matched, ${unmatched.length} unmatched items. Results downloaded.`, 'success');

            } catch (error) {
                console.error("Error processing data:", error);
                showMessage(`Error during processing: ${error.message}`, 'error');
            } finally {
                 checkProcessButtonState(); // Re-check button state after processing attempt
            }
        }

        // --- Transfer Log Handling ---

        function logTransfer(from, to, resultsData, unmatchedData) {
            const timestamp = new Date().toISOString(); // ISO format is good for sorting/parsing

             // Store only summary data in the log to keep LocalStorage size manageable
             // If you need to re-download exact files, you'd need to store resultsData/unmatchedData
             // but that can quickly exceed LocalStorage limits.
            const logEntry = {
                id: timestamp + "_" + Math.random().toString(36).substring(2, 9), // Unique ID
                timestamp: timestamp,
                locationFrom: from,
                locationTo: to,
                matchedCount: resultsData.length,
                unmatchedCount: unmatchedData.length,
                 // Storing full data can be large! Consider if needed.
                 // results: resultsData,
                 // unmatched: unmatchedData
            };

            transferLog.unshift(logEntry); // Add to the beginning of the array
            localStorage.setItem('transferLog', JSON.stringify(transferLog));
            renderTransferLog(); // Update the displayed table
        }

        function renderTransferLog() {
            transferLogTableBody.innerHTML = ''; // Clear existing rows

            if (transferLog.length === 0) {
                transferLogTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; color: #888;">No transfers logged yet.</td></tr>';
                exportLogButton.disabled = true;
                clearLogButton.disabled = true;
                return;
            }

             exportLogButton.disabled = false;
             clearLogButton.disabled = false;

            transferLog.forEach(entry => {
                const row = transferLogTableBody.insertRow();
                const timestamp = new Date(entry.timestamp);

                row.insertCell().textContent = timestamp.toLocaleString(); // Human-readable time
                row.insertCell().textContent = entry.locationFrom;
                row.insertCell().textContent = entry.locationTo;
                row.insertCell().textContent = entry.matchedCount;
                row.insertCell().textContent = entry.unmatchedCount;

                // Actions Cell (Example: Delete Entry)
                const actionsCell = row.insertCell();
                const deleteButton = document.createElement('button');
                deleteButton.innerHTML = '<span class="material-icons" style="font-size: 1em;">delete</span>'; // Smaller icon
                 deleteButton.classList.add('secondary-button', 'danger-button');
                 deleteButton.title = 'Delete this log entry';
                deleteButton.style.padding = '2px 6px'; // Smaller padding
                 deleteButton.onclick = () => deleteLogEntry(entry.id);
                actionsCell.appendChild(deleteButton);

                // Add more actions here if needed (e.g., re-download if full data was stored)
            });
        }

        function deleteLogEntry(entryId) {
            if (confirm("Are you sure you want to delete this log entry? This cannot be undone.")) {
                transferLog = transferLog.filter(entry => entry.id !== entryId);
                localStorage.setItem('transferLog', JSON.stringify(transferLog));
                renderTransferLog();
                showMessage('Log entry deleted.', 'info');
            }
        }


        function clearTransferLog() {
            if (confirm("Are you sure you want to clear the entire transfer log? This action cannot be undone.")) {
                transferLog = [];
                localStorage.removeItem('transferLog');
                renderTransferLog();
                showMessage('Transfer log cleared.', 'info');
            }
        }

         function exportTransferLog() {
             if (transferLog.length === 0) {
                 showMessage('Nothing in the log to export.', 'info');
                 return;
             }

             showMessage('Preparing log export...', 'info');
             try {
                 const exportData = transferLog.map(entry => ({
                     Timestamp: new Date(entry.timestamp).toLocaleString(),
                     From: entry.locationFrom,
                     To: entry.locationTo,
                     Matched: entry.matchedCount,
                     Unmatched: entry.unmatchedCount,
                      // Add more fields if you stored more data in the log entry
                 }));

                 const worksheet = XLSX.utils.json_to_sheet(exportData);
                  worksheet['!cols'] = [{ wch: 25 }, { wch: 20 }, { wch: 20 }, { wch: 10 }, { wch: 10 }];
                 const workbook = XLSX.utils.book_new();
                 XLSX.utils.book_append_sheet(workbook, worksheet, 'Transfer Log');

                 const now = new Date();
                  const formattedDate = now.toLocaleDateString().replace(/\//g, '-');
                 const filename = `Kero_Transfer_Log_${formattedDate}.xlsx`;
                 XLSX.writeFile(workbook, filename);
                 showMessage('Transfer log exported successfully.', 'success');
             } catch (error) {
                 console.error("Error exporting log:", error);
                 showMessage(`Error exporting log: ${error.message}`, 'error');
             }
         }


        // --- Utility Functions ---
        function showMessage(message, type = 'error') { // Default to error
            messageDiv.innerText = message;
            messageDiv.className = type; // 'success', 'error', or 'info'
            // Auto-clear info/success messages after a delay?
            // if (type === 'success' || type === 'info') {
            //     setTimeout(() => {
            //         if (messageDiv.innerText === message) { // Clear only if message hasn't changed
            //             messageDiv.innerText = '';
            //             messageDiv.className = '';
            //         }
            //     }, 5000); // Clear after 5 seconds
            // }
        }

    </script>

</body>

</html>
